# 2025-09-07 开发日志（数据整合与 3D 结构导出）

本次工作围绕三部分展开：
- 三源数据的合并规范与统一键（slug）对齐
- 基于 Mol* 染色规则的结构导出与注释 mmCIF 生成
- Sequences 页面前端集成（提供 mmCIF 下载与批量下载）

---

## 1) 改动概览（文件与核心功能）

- 新增脚本
  - `scripts/merge_data.py`：合并三份数据为统一结构（posts_data.json + sequences_cleaned.json + structure-6.20.split.json）。
  - `scripts/prepare_colored_structure_configs.py`：从合并数据提取 3D 页面的 PDB 与配色规则，生成配置与索引。
  - `scripts/export_mmcif_with_annotations.py`：下载/复用 mmCIF，按 Mol* 配色规则在文件头注释写入“颜色矩阵”，并为每个 aptamer 打包 zip。
  - 可选（Mol* 状态导出链路）
    - `scripts/molstar_exporter.html`：最小 Mol* 页面，加载 PDB 并应用配色，支持导出状态。
    - `scripts/export_colored_structures.js`：基于 Puppeteer 批量打开 exporter 页面、应用配色并导出 Mol* 状态文件（.molj）。
- 前端
  - `/_pages/sequences.md`：
    - 新增表头列“3D mmCIF”。
    - 页面加载 `apidata/colored_structures/index.json`，按 `Linker` 解析 slug 并渲染下载按钮：优先 zip（包含所有 annotated mmCIF），否则单文件。
    - 在“Export Selected / Export All Results”后，自动检测当页涉及的 aptamer 并触发批量 mmCIF 下载（浏览器将提示允许多文件下载）。
- 其他
  - `package.json`：追加 `puppeteer`（用于可选的 Mol* 状态导出链路）与 `export:3d` 脚本（非必须）。

---

## 2) 数据合并与对齐（slug 作为主键）

- 合并脚本：`scripts/merge_data.py`
  - 以页面 slug（例如 `Hfq-aptamer`）对齐三源：
    - posts: `apidata/posts_data.json` → `posts[slug]`
    - sequences: `apidata/sequences_cleaned.json` → 取 `Linker`（如 `/_posts/Hfq-aptamer`）提取 slug
    - structures: `apidata/structure-6.20.split.json` → 取 `AptamerLinker` 提取 slug
  - 输出（默认）：`apidata/merged_data.json`
  - 支持 `--single` 仅处理指定 title/name。

- 结果结构（节选，按 aptamer 聚合）：
  - `post.meta`（title/type/tags 等）
  - `structure.viewer`（pdb_info、color_schemes 等）
  - `sequences.records`（来自 sequences_cleaned 的规范化条目）
  - `structure.summary`（来自 structures 表，含 pdb_ids 等）

> 注：`apidata/merged_data_0907.json` 为本次统计与导出所用快照。

---

## 3) 3D 链路与 mmCIF 注释导出

### 3.1 生成颜色配置与索引
- `scripts/prepare_colored_structure_configs.py`
  - 输入：`apidata/merged_data_0907.json`
  - 输出：`apidata/colored_structures/index.json` 与每个 slug 的 `config.json`
  - 示例输出结构：
    - `apidata/colored_structures/Hfq-aptamer/config.json`
    - `apidata/colored_structures/index.json`

### 3.2 注释 mmCIF 导出（主链路）
- `scripts/export_mmcif_with_annotations.py`
  - 功能：
    - 解析每个 aptamer 的 PDB 列表（`structure.summary.pdb_ids`，如空则从 `viewer.pdb_info.pdb_file_path` 推断）
    - 下载或复用本地 `*.cif`（支持 `.cif.gz` 解压与多次重试）
    - 写出 `*.annotated.cif`，在 mmCIF 头部注释写入“颜色矩阵”
    - 为每个 aptamer 打包 `slug.mmcif.zip`（包含全部 annotated cif 与 config.json）
    - 更新 `apidata/colored_structures/index.json`
  - 注释格式（便于人工核查）：
    - `# annotation.color_ranges (columns: chain,start,end,r,g,b)`
    - `# annotation.color_residues (columns: chain,residue,r,g,b)`（逐残基展开）
  - 关键参数：
    - `--offline`：仅处理本地已有 cif，不联网
    - `--net-timeout`：单次请求超时（默认 60s）
    - `--net-retries`：重试次数（默认 4）
    - `--retry-delay`：重试回退基数（默认 2.0s）
  - 运行示例：
    ```bash
    # 全量
    python scripts/export_mmcif_with_annotations.py \
      --merged apidata/merged_data_0907.json \
      --output apidata/colored_structures

    # 离线（只注释本地已存在的 cif）
    python scripts/export_mmcif_with_annotations.py \
      --offline \
      --merged apidata/merged_data_0907.json \
      --output apidata/colored_structures

    # 增强网络容错
    python scripts/export_mmcif_with_annotations.py \
      --merged apidata/merged_data_0907.json \
      --output apidata/colored_structures \
      --net-timeout 120 --net-retries 6 --retry-delay 3
    ```

### 3.3 可选：Mol* 状态导出
- `scripts/molstar_exporter.html` + `scripts/export_colored_structures.js`
  - 用于生成 `.molj`（Mol* 状态文件，非 mmCIF 必需）。
  - 依赖 `puppeteer`，脚本 `npm run export:3d`。
  - 网络/权限问题时可跳过，不影响 mmCIF 主链路。

---

## 4) Sequences 页面集成（mmCIF 下载）

- 文件：`_pages/sequences.md`
  - 新增列“3D mmCIF”。
  - 页面加载时读取 `apidata/colored_structures/index.json`，构建映射：`slug -> { annotated[], zip }`。
  - 渲染规则：
    - 有 zip → 显示 “mmCIF (zip)” 下载按钮；
    - 否则显示第一份 annotated cif 下载链接，并提示 `(+N more)`。
  - 批量下载：
    - 在 “Export Selected / Export All Results” 后，检测涉及 aptamer 的 zip 或 annotated 列表，提示用户一次性触发浏览器多文件下载。

- 生成产物目录结构（示例 Hfq）：
  - `apidata/colored_structures/Hfq-aptamer/3HSB.cif`
  - `apidata/colored_structures/Hfq-aptamer/3HSB.annotated.cif`
  - `apidata/colored_structures/Hfq-aptamer/Hfq-aptamer.mmcif.zip`
  - `apidata/colored_structures/Hfq-aptamer/config.json`
  - `apidata/colored_structures/index.json`

> 浏览器可能要求“允许多个下载”。

---

## 5) 统计与一致性说明

- 基于 `apidata/merged_data_0907.json` 的统计：
  - 总 aptamer：191
  - 有 2D 展示：182
  - 有 3D 展示：50
  - 同时有 3D 展示 & 结构表记录：45
  - 有 3D 展示但结构表缺失：5
- `structure-6.20.split.json` 行数为 52，但唯一 aptamer 为 48（重复 4 个 slug，每个对应多 PDB 条目：`Theophylline-aptamer`、`Spinach-aptamer`、`ATP-aptamer`、`Ribostamycin-aptamer`）。

---

## 6) 已知问题与建议

- 命名差异导致对齐偏差（示例：`HIV-Tat-aptamer` vs `HIV-1-Tat-protein-aptamer`）。建议维护 slug 同义映射表，或在合并时引入更强的别名逻辑。
- 网络不稳定时的下载失败：已提供重试/超时/离线模式，可配更高超时或先本地补齐 cif 再 `--offline` 注释。
- 前端批量下载目前逐个触发（zip 优先），如需“选中条目 → 单个总 zip”，可引入 JSZip 在前端打包（或后端事先打包）。
- 注释矩阵目前包含逐残基展开，文件体积略增；如需精简，可增加命令行开关切换仅输出区间表。

---

## 7) 快速运行指引

1. 合并数据（可选）
   ```bash
   python scripts/merge_data.py \
     --posts apidata/posts_data.json \
     --sequences apidata/sequences_cleaned.json \
     --structures apidata/structure-6.20.split.json \
     --output apidata/merged_data.json
   ```
2. 生成 3D 配色配置与索引（可选，用于排查）
   ```bash
   python scripts/prepare_colored_structure_configs.py \
     --merged apidata/merged_data_0907.json \
     --output apidata/colored_structures
   ```
3. 导出注释 mmCIF（主链路）
   ```bash
   python scripts/export_mmcif_with_annotations.py \
     --merged apidata/merged_data_0907.json \
     --output apidata/colored_structures
   ```
4. 本地预览站点（示例）
   ```bash
   bundle exec jekyll serve
   # /sequences/ 页面将显示 3D mmCIF 下载列
   ```

---

## 8) 相关文件索引

- 合并与导出脚本
  - `scripts/merge_data.py`
  - `scripts/prepare_colored_structure_configs.py`
  - `scripts/export_mmcif_with_annotations.py`
  - `scripts/molstar_exporter.html`
  - `scripts/export_colored_structures.js`
- 前端页面
  - `_pages/sequences.md`
- 产出数据
  - `apidata/merged_data_0907.json`
  - `apidata/colored_structures/index.json`
  - `apidata/colored_structures/<slug>/*.cif`
  - `apidata/colored_structures/<slug>/*.annotated.cif`
  - `apidata/colored_structures/<slug>/<slug>.mmcif.zip`

> 以上改动均已与现有代码保持最小侵入与直观可回滚性，便于后续维护与扩展。

